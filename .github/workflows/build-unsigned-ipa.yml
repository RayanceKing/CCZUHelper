name: Build Unsigned IPA on Tag or Manual Trigger

on:
  # 1. ç›‘å¬ Tag çš„åˆ›å»ºäº‹ä»¶
  push:
    tags:
      - 'v*.*.*' # åŒ¹é…ä»»ä½•ä»¥ 'v' å¼€å¤´ï¼ŒåŽè·Ÿè‡³å°‘ä¸¤ä¸ªç‚¹çš„ Tagï¼Œå¦‚ v1.0.0, v1.2.3
      - 'V*.*.*' # ä¹ŸåŒ¹é…å¤§å†™ V å¼€å¤´çš„ Tag

  # 2. å…è®¸æ‰‹åŠ¨è§¦å‘ (Workflow Dispatch)
  workflow_dispatch: 

jobs:
  build_ipa:
    runs-on: macos-latest 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Get Tag Name (for Naming IPA)
        id: tag_name
        run: echo "TAG_NAME=$(echo ${{ github.ref_name }} | sed 's/\//-/g')" >> $GITHUB_OUTPUT
        # è¿™ä¸€æ­¥æ˜¯ä¸ºäº†èŽ·å– Tag åç§°ï¼ˆä¾‹å¦‚ v1.0.0ï¼‰ï¼Œå¹¶ç”¨äºŽåŽç»­çš„ IPA æ–‡ä»¶å‘½åä¸­ã€‚

      # 3. Archive the Project (Without Code Signing)
      - name: Archive the Project (Without Code Signing)
        run: |
          # ðŸš¨ ç¡®ä¿ -project åç§°å’Œ -scheme åç§°ä¸Žæ‚¨çš„é¡¹ç›®åŒ¹é…
          xcodebuild \
            -project CCZUHelper.xcodeproj \
            -scheme CCZUHelper \
            -configuration Release \
            -archivePath build/CCZUHelper.xcarchive \
            archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_IDENTITY=""
        
      # 4. Create Unsigned IPA Package
      - name: Create Unsigned IPA Package
        run: |
          ARCHIVE_PATH="build/CCZUHelper.xcarchive"
          APP_NAME="CCZUHelper.app"
          IPA_FILENAME="CCZUHelper-${{ steps.tag_name.outputs.TAG_NAME }}.ipa"
          
          # å¯¼èˆªåˆ° Products/Applications ç›®å½•
          cd "$ARCHIVE_PATH/Products/Applications"
          
          # åˆ›å»º Payload ç›®å½•
          mkdir Payload
          
          # å¤åˆ¶ .app æ–‡ä»¶åˆ° Payload
          cp -R "$APP_NAME" Payload/
          
          # åŽ‹ç¼©ç”Ÿæˆ IPA æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ Tag åç§°å‘½å
          zip -r "$IPA_FILENAME" Payload
          
          # ç§»åŠ¨ IPA åˆ°å·¥ä½œç›®å½•æ ¹ç›®å½•
          mv "$IPA_FILENAME" ../../../
          
          # è¾“å‡ºæœ€ç»ˆçš„æ–‡ä»¶åï¼Œä¾› Artifact Upload ä½¿ç”¨
          echo "IPA_PATH=build/$IPA_FILENAME" >> $GITHUB_ENV

      # 5. Upload IPA Artifact
      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: CCZUHelper-Unsigned-IPA-${{ steps.tag_name.outputs.TAG_NAME }}
          path: ${{ env.IPA_PATH }}
          retention-days: 14