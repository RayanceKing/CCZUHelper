# .github/workflows/release.yml

name: 'Build & Release Unsigned Artifacts'

on:
  push:
    tags:
      - 'v*' # 监听所有以 'v' 开头的标签 (e.g., v1.0.0)

jobs:
  build:
    runs-on: macos-latest # 必须使用 macOS Runner

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      # --- 关键步骤 1: 解决 Ruby/Bundler 兼容性问题 ---
      - name: Set up Ruby and Install Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'  # 使用 Ruby 3.3+
          bundler-cache: true  # 自动运行 bundle install
          bundler: 2.5         # 强制使用 Bundler 2.x 版本，解决 untaint 错误
          
      # --- 关键步骤 2: 构建未签名产物 ---
      - name: Run Fastlane Build
        # 设置环境变量以禁用签名，供 Fastlane/Xcodebuild 使用
        env:
          # 以下变量指示 xcodebuild 禁用签名
          CODE_SIGNING_REQUIRED: "NO"
          CODE_SIGN_IDENTITY: ""
          
          # 以下变量指示 fastlane gym 禁用签名
          GYM_CODE_SIGNING_IDENTITY: ""
          GYM_PROVISIONING_PROFILE_SPECIFIER: ""
          GYM_EXPORT_METHOD: "development"
          GYM_SKIP_CODESIGNING: "true"
          
        run: |
          # 因为上一步已运行 bundle install，这里可以直接执行 fastlane
          fastlane build_unsigned_artifacts
          
      # --- 关键步骤 3: 上传产物到 Release ---
      - name: Upload Artifacts to Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            output/CCZUHelper_Unsigned_iOS_WatchOS.ipa
            output/CCZUHelper_macOS_Unsigned.app
            # 可以在这里添加其他需要上传的产物
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub 自动提供的 Token