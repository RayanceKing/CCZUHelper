name: Build and Release (iOS + macOS)

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      ##############################################
      # ‚ùó ÈÄöÁî®ÈÖçÁΩÆ
      ##############################################

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Create output directory
        run: mkdir -p output

      ##############################################
      # üì± ÊûÑÂª∫ iOS & ÂØºÂá∫ IPA
      ##############################################

      - name: Build iOS (archive)
        run: |
          xcodebuild \
            -scheme CCZUHelper \
            -sdk iphoneos \
            -configuration Release \
            -archivePath build/ios.xcarchive \
            archive

      - name: Export IPA
        run: |
          # ÁîüÊàê‰∏Ä‰∏™ÊúÄÂü∫Á°ÄÁöÑ ExportOptions.plistÔºàÊú™Á≠æÂêç IPAÔºâ
          cat <<EOF > ExportOptions.plist
          {
            "method": "development",
            "compileBitcode": false,
            "destination": "export",
            "manageAppVersionAndBuildNumber": false,
            "signingStyle": "manual"
          }
          EOF

          xcodebuild \
            -exportArchive \
            -archivePath build/ios.xcarchive \
            -exportPath build/ios_export \
            -exportOptionsPlist ExportOptions.plist

      - name: Copy iOS outputs
        run: |
          cp build/ios_export/*.ipa output/CCZUHelper-iOS.ipa
          cp -R build/ios.xcarchive/Products/Applications/CCZUHelper.app output/CCZUHelper-iOS.app

      ##############################################
      # üíª ÊûÑÂª∫ macOS Â∫îÁî®
      ##############################################

      - name: Build macOS
        run: |
          xcodebuild \
            -scheme CCZUHelper \
            -sdk macosx \
            -configuration Release \
            -archivePath build/macos.xcarchive \
            archive

      - name: Export macOS .app
        run: |
          cp -R build/macos.xcarchive/Products/Applications/CCZUHelper.app output/CCZUHelper-macOS.app

      - name: Zip macOS app
        run: |
          cd output
          zip -r CCZUHelper-macOS.zip CCZUHelper-macOS.app

      ##############################################
      # üì¶ ÂèëÂ∏É Release
      ##############################################

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            output/CCZUHelper-iOS.ipa
            output/CCZUHelper-iOS.app
            output/CCZUHelper-macOS.app
            output/CCZUHelper-macOS.zip
          token: ${{ secrets.GITHUB_TOKEN }}
