name: Build and Release

on:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -------------------------------
      # üîß ÁéØÂ¢ÉÈÖçÁΩÆÔºà‰ΩøÁî®ÊúÄÊñ∞ XcodeÔºâ
      # -------------------------------
      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Create output directory
        run: mkdir -p output

      # =====================================================================
      # üì± iOS Êó†Á≠æÂêçÊûÑÂª∫ (.app + .ipa)
      # =====================================================================
      - name: Build iOS (Archive - Unsigned)
        run: |
          xcodebuild \
            -workspace CCZUHelper.xcworkspace \
            -scheme CCZUHelper \
            -configuration Release \
            -sdk iphoneos \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            -archivePath build/ios.xcarchive \
            archive

      - name: Export iOS IPA (Unsigned)
        run: |
          cat <<EOF > ExportOptions.plist
          {
            "method": "development",
            "signingStyle": "manual",
            "stripSwiftSymbols": false,
            "compileBitcode": false
          }
          EOF

          xcodebuild -exportArchive \
            -archivePath build/ios.xcarchive \
            -exportPath build/ios_export \
            -exportOptionsPlist ExportOptions.plist \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY=""

      - name: Move iOS outputs
        run: |
          cp build/ios_export/*.ipa output/CCZUHelper-iOS-unsigned.ipa
          cp -R build/ios.xcarchive/Products/Applications/CCZUHelper.app \
             output/CCZUHelper-iOS-unsigned.app

      # =====================================================================
      # üíª macOS ÊûÑÂª∫ (.app + .zip)
      # =====================================================================
      - name: Build macOS
        run: |
          xcodebuild \
            -workspace CCZUHelper.xcworkspace \
            -scheme CCZUHelper \
            -configuration Release \
            -sdk macosx \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            -archivePath build/macos.xcarchive \
            archive

      - name: Export macOS .app
        run: |
          cp -R build/macos.xcarchive/Products/Applications/CCZUHelper.app \
             output/CCZUHelper-macOS-unsigned.app

      - name: Zip macOS App
        run: |
          cd output
          zip -r CCZUHelper-macOS-unsigned.zip CCZUHelper-macOS-unsigned.app

      # =====================================================================
      # üì¶ ÂèëÂ∏ÉÂà∞ ReleaseÔºàËá™Âä®Ôºâ
      # =====================================================================
      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            output/CCZUHelper-iOS-unsigned.ipa
            output/CCZUHelper-iOS-unsigned.app
            output/CCZUHelper-macOS-unsigned.app
            output/CCZUHelper-macOS-unsigned.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
