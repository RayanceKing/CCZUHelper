# CCZUHelper 功能更新说明

## 更新日期: 2025年12月1日

本次更新实现了以下功能：

## 1. 课程表页面增强 ✅

### 左右滑动切换周视图
- 使用 `TabView` 实现周视图的左右滑动切换
- 支持查看过去和未来的课程安排（-52周至+52周）
- 滑动时课程数据自动更新，只显示对应周次的课程

### 顶部日期联动
- 顶部日期显示自动跟随周视图切换
- 显示当前查看周的年月和周次
- 日期选择器可以快速跳转到指定日期

### 红色当前时间线
- 在当前周的课程表上显示实时的红色时间线
- 时间线自动根据当前小时和分钟定位
- 只在显示时间范围内且为今天时显示
- 时间线包含圆点标记和横线，清晰易见

### "今日"按钮快速回弹
- 点击"今日"按钮快速返回当前周
- 带有动画效果的平滑过渡
- 自动滚动到当前时间位置

## 2. 教务系统课表导入 ✅

### CCZUKit 集成
- 集成 CCZUKit 库实现与教务系统的对接
- 使用 `DefaultHTTPClient` 进行 SSO 统一认证
- 通过 `JwqywxApplication` 访问教务系统
- 使用 `CalendarParser` 解析课表数据

### 课表导入流程
1. 用户登录账号（统一身份认证）
2. 从教务系统获取当前学期课表
3. 自动解析课程信息（名称、教师、地点、周次、时间等）
4. 创建新课表并设为当前活跃课表
5. 自动为课程分配颜色

### 数据结构
- 创建 `CourseInfo` 结构体存储解析后的课程信息
- 支持多周次课程
- 自动提取学期名称

### 安全考虑
- 代码中预留了密码安全存储的接口
- 建议使用 Keychain 存储用户凭据
- 当前版本包含占位实现，实际部署需完善

## 3. 服务页面功能实现 ✅

### 成绩查询 (GradeQueryView)
- 显示课程成绩列表
- 支持按学期筛选
- 显示学分、成绩、绩点信息
- 成绩根据分数段显示不同颜色
- 区分必修/选修课程类型
- 预留 CCZUKit 集成接口

### 考试安排 (ExamScheduleView)
- 显示考试日程
- 包含考试时间、地点、座位号
- 清晰的日历和时钟图标
- 预留 CCZUKit 集成接口

### 空闲教室查询 (EmptyClassroomView)
- 支持按教学楼筛选
- 支持按星期和时间段查询
- 显示教室容量和楼层信息
- 实时查询可用教室
- 预留 CCZUKit 集成接口

### 服务页面导航
- 点击服务卡片打开对应功能
- 使用 sheet 方式呈现详细页面
- 统一的关闭按钮和导航体验

## 4. 茶楼(论坛)功能 ✅

### 数据模型
创建了三个主要模型类：

1. **TeahousePost** - 帖子模型
   - 帖子标题、内容、分类
   - 作者信息（支持匿名）
   - 图片列表（最多9张）
   - 点赞数、评论数
   - 本地/云端同步状态
   - 时间戳

2. **TeahouseComment** - 评论模型
   - 评论内容
   - 关联帖子ID
   - 作者信息
   - 同步状态

3. **UserLike** - 点赞记录
   - 用户ID
   - 帖子ID
   - 点赞时间

### 发帖功能 (CreatePostView)
- 6个分类选择：学习、生活、二手、表白墙、失物招领、其他
- 支持输入标题和内容
- 支持上传最多9张图片
- 图片预览和删除功能
- 支持匿名发布
- 表单验证（标题和内容必填）

### 本地存储
- 使用 SwiftData 持久化存储帖子
- 图片保存到本地 Documents 目录
- 帖子标记为"本地"状态
- 显示橙色"本地"标签

### 帖子展示
- 按时间倒序显示
- 支持按分类筛选
- 显示作者、时间、分类
- 智能时间显示（刚刚、x分钟前、x小时前等）
- 图片横向滚动预览（最多显示3张）
- 点赞和评论计数

### 互动功能
- 点赞/取消点赞
- 点赞状态持久化
- 点赞图标变色反馈
- 预留评论和分享功能接口

### 未来扩展接口
预留了服务器同步相关的接口：

```swift
// 预留的服务器同步接口
private func syncToServer(_ post: TeahousePost) {
    // TODO: 实现与服务器的同步逻辑
    // 1. 上传图片到服务器
    // 2. 上传帖子数据到服务器
    // 3. 更新本地帖子的同步状态
}
```

同步状态枚举：
- `local` - 本地未同步
- `syncing` - 同步中
- `synced` - 已同步
- `failed` - 同步失败

## 技术实现细节

### 架构优化
- 使用 SwiftData 进行数据持久化
- 使用 @Query 进行响应式数据查询
- 使用 @Environment 共享应用设置
- 模块化的视图组件设计

### 性能优化
- LazyVStack 延迟加载帖子列表
- TabView 实现高效的页面切换
- 图片异步加载和缓存
- 合理的数据查询范围（-52到+52周）

### 用户体验
- 流畅的动画过渡效果
- 清晰的加载状态提示
- 友好的错误处理和提示
- 统一的交互模式

## 项目文件结构

```
CCZUHelper/
├── Models/
│   ├── Course.swift           # 课程模型
│   ├── AppSettings.swift      # 应用设置
│   └── TeahousePost.swift     # 茶楼帖子模型（新增）
├── Views/
│   ├── ScheduleView.swift     # 课程表视图（增强）
│   ├── ServicesView.swift     # 服务视图（增强）
│   ├── TeahouseView.swift     # 茶楼视图（重构）
│   ├── CreatePostView.swift   # 发帖视图（新增）
│   ├── ManageSchedulesView.swift  # 课表管理（完善）
│   └── Services/
│       ├── GradeQueryView.swift      # 成绩查询（新增）
│       ├── ExamScheduleView.swift    # 考试安排（新增）
│       └── EmptyClassroomView.swift  # 空闲教室（新增）
└── CCZUHelperApp.swift        # 主应用（更新数据模型）
```

## 待完善功能

1. **密码安全存储**
   - 使用 Keychain 存储用户密码
   - 实现安全的凭据管理

2. **服务器同步**
   - 实现帖子上传接口
   - 图片CDN上传
   - 双向数据同步
   - 冲突解决机制

3. **评论功能**
   - 评论列表展示
   - 发表评论
   - 评论点赞

4. **更多服务**
   - 学分绩点计算
   - 图书馆功能
   - 校园卡查询
   - 校园网管理

5. **用户系统**
   - 用户个人主页
   - 我的帖子管理
   - 消息通知
   - 草稿箱

## 测试建议

1. 测试课程表左右滑动和时间线显示
2. 测试"今日"按钮的回弹效果
3. 测试发帖功能和图片上传
4. 测试点赞功能的状态切换
5. 测试各个服务页面的打开和关闭
6. 测试数据持久化（关闭应用后重新打开）

## 注意事项

- 当前版本的服务数据为模拟数据
- 教务系统导入需要有效的账号密码
- 帖子图片保存在本地，注意存储空间
- 建议在真机上测试以获得最佳体验
