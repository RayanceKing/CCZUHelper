# fastlane/Fastfile

platform :ios do
  desc "Archives all targets without signing for distribution"
  lane :build_unsigned_artifacts do
    
    # --- 1. iOS (iPhone/iPad) & watchOS/visionOS Archive ---
    # 我们先对主 Target (CCZUHelper) 进行 Archive。
    # 包含 watchOS 和 Widget 的依赖通常也会打包进去。
    # 我们使用 `skip_codesigning: true` 来指示 fastlane 跳过签名。
    archive(
      workspace: "CCZUHelper.xcworkspace",
      scheme: "CCZUHelper",
      archive_path: "build/CCZUHelper.xcarchive",
      clean: true,
      skip_codesigning: true # 关键：跳过签名
    )
    
    # --- 2. 导出未签名的 .ipa (iOS) ---
    export_options = {
      method: "development",
      signing_style: "manual",
      strip_swift_symbols: true,
      provisioning_profiles: {} # 关键：确保配置文件为空
    }
    
    # 尝试导出 IPA (注意：这一步在 CI 上可能会失败，因为没有证书，但会保留 .app 文件)
    export_ipa(
        archive_path: "build/CCZUHelper.xcarchive",
        export_path: "output/CCZUHelper_Unsigned",
        output_name: "CCZUHelper_Unsigned.ipa",
        export_options: export_options
    )
    
    # --- 3. 提取 .app 文件并手动压缩 (确保生成未签名 IPA) ---
    sh "cp -R build/CCZUHelper.xcarchive/Products/Applications/CCZUHelper.app output/Payload/CCZUHelper.app"
    sh "zip -r output/CCZUHelper_Unsigned.ipa output/Payload"
    
    # --- 4. macOS (应用 Target) ---
    # 对于 macOS，通常直接导出 .app 目录即可
    # 构建 macOS Target 并将其放在输出目录
    xcodebuild(
      workspace: "CCZUHelper.xcworkspace",
      scheme: "CCZUHelper",
      configuration: "Release",
      sdk: "macosx",
      archive: true,
      archive_path: "build/CCZUHelper_macOS.xcarchive",
      destination: "generic/platform=macOS",
      build_settings: {
        "CODE_SIGNING_REQUIRED" => "NO",
        "CODE_SIGN_IDENTITY" => ""
      }
    )
    sh "cp -R build/CCZUHelper_macOS.xcarchive/Products/Applications/CCZUHelper.app output/CCZUHelper_macOS_Unsigned.app"
    
    # --- 5. watchOS 提取（通常包含在主 IPA/App 中，但为清晰起见，单独指出）---
    # watchOS 产物通常位于主 .ipa/App 的 Watch 目录中，在导出的 .ipa 中即可找到。
    
    # --- 6. 上传产物列表 ---
    artifact_paths = [
      "output/CCZUHelper_Unsigned.ipa",
      "output/CCZUHelper_macOS_Unsigned.app"
    ]
    
    return artifact_paths
  end
end